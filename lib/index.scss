@use "sass:list" as list;
@use "sass:map" as map;
@use "config" as config;
@use "generators" as generators;
@use "media" as media;
@use "normalize" as normalize;

//
// All the selectors available to be enabled for a generator.
//
$selectors: (
  // pseudo classes
  hover: ":hover",
  focus: ":focus",
  focus-within: ":focus-within",
  focus-visible: ":focus-visible",
  active: ":active",
  visited: ":visited",
  target: ":target",
  first: ":first-child",
  last: ":last-child",
  only: ":only-child",
  odd: ":nth-child(odd)",
  even: ":nth-child(even)",
  first-of-type: ":first-of-type",
  last-of-type: ":last-of-type",
  only-of-type: ":only-of-type",
  empty: ":empty",
  disabled: ":disabled",
  checked: ":checked",
  indeterminate: ":indeterminate",
  default: ":default",
  required: ":required",
  valid: ":valid",
  invalid: ":invalid",
  in-range: ":in-range",
  out-of-range: ":out-of-range",
  placeholder-shown: ":placeholder-shown",
  autofill: ":autofill",
  read-only: ":read-only",
  rtl: ":dir(rtl)",
  ltr: ":dir(ltr)",
  // pseudo elements
  before: "::before",
  after: "::after",
  first-letter: "::first-letter",
  first-line: "::first-line",
  marker: "::marker",
  selection: "::selection",
  file: "::file-selector-button",
  placeholder: "::placeholder",
  // attribute selectors
  open: "[open]",
  rtl-attr: "[dir="rtl"]",
  ltr-attr: "[dir="ltr"]",
);

//
// Takes in a list of values and returns them each joined with the configured separator.
// Return value will always have a trailing separator so it can be prefixed to other class names.
//
@function prefix($values) {
  $prefix: "";

  @each $value in $values {
    @if $value != null and $value != "" {
      $prefix: $prefix + $value + config.$separator;
    }
  }

  @return $prefix;
}

//
// Renders content within a dark mode media query or class depending on which is enabled.
//
@mixin dark-mode-content {
  @if config.$dark-mode == media {
    @include media.media-dark {
      @content;
    }
  }

  @if config.$dark-mode == class {
    .dark {
      @content;
    }
  }
}

//
// Loops through each generator list and renders classes for each generator. Can be used with any
// number of class prefixes.
//
// For example, calling `@include generator-content(__, "foo", "bar")` will result in class names
// such as `.foo\:bar\:classname:selector {}`.
//
@mixin generator-content($generators, $prefixes...) {
  @each $type, $enabled in $generators {
    @if $type == base {
      @include generators.render($enabled, prefix($prefixes));
    }

    @else if map.get($selectors, $type) {
      $prepend: prefix(list.append($prefixes, $type));
      $append: map.get($selectors, $type);

      @include generators.render($enabled, $prepend, $append);
    }
  }
}

//
// Kick things off
//
@mixin render {
  @if config.$normalize {
    @include normalize.modern();
    @include normalize.custom();
  }

  @include generator-content(config.$generators);

  @include dark-mode-content {
    @include generator-content(map.get(config.$generators, dark), dark);
  }

  @each $name, $value in config.$screens {
    @include media.media-up-to($name) {
      @include generator-content(map.get(config.$generators, responsive), $name);

      @include dark-mode-content {
        @if map.has-key(config.$generators, responsive, dark) {
          @include generator-content(map.get(config.$generators, responsive, dark), dark, $name);
        } @else {
          @include generator-content(map.get(config.$generators, dark), dark, $name);
        }
      }
    }
  }
}
